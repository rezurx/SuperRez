#!/usr/bin/env python3
"""
Kimi K2 CLI wrapper for SuperRez integration
Uses Moonshot API with OpenAI-compatible interface
"""

import os
import sys
import json
import argparse

def main():
    # Handle --version flag for SuperRez detection
    if len(sys.argv) > 1 and sys.argv[1] == '--version':
        print("kimi CLI v1.0.0 - Kimi K2 via Moonshot API")
        sys.exit(0)
    
    # Check for API key
    api_key = os.getenv('MOONSHOT_API_KEY')
    if not api_key:
        print("Error: MOONSHOT_API_KEY environment variable not set", file=sys.stderr)
        print("Get your API key from: https://platform.moonshot.ai/console/api-keys", file=sys.stderr)
        sys.exit(1)
    
    # Get prompt from command line args or stdin
    if len(sys.argv) > 1:
        prompt = ' '.join(sys.argv[1:])
    elif not sys.stdin.isatty():
        prompt = sys.stdin.read().strip()
    else:
        print("Usage: kimi 'your prompt here' or echo 'prompt' | kimi", file=sys.stderr)
        sys.exit(1)
    
    if not prompt:
        print("Error: No prompt provided", file=sys.stderr)
        sys.exit(1)
    
    # Use OpenAI library with Moonshot endpoint
    try:
        import openai
    except ImportError:
        print("Error: openai library not installed. Run: pip install openai", file=sys.stderr)
        sys.exit(1)
    
    # Configure OpenAI client for Moonshot
    client = openai.OpenAI(
        api_key=api_key,
        base_url="https://api.moonshot.ai/v1"
    )
    
    try:
        response = client.chat.completions.create(
            model="moonshot-v1-8k",
            messages=[
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            temperature=0.2,
            max_tokens=2000
        )
        
        print(response.choices[0].message.content.strip())
        
    except Exception as e:
        print(f"API Error: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()